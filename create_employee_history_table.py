from app import create_app, db
from sqlalchemy import text

app = create_app('dev')

with app.app_context():
    try:
        with db.engine.connect() as conn:
            print("Creating employee_history table...")
            
            # Create employee_history table (PostgreSQL syntax)
            create_table_sql = text("""
                CREATE TABLE IF NOT EXISTS employee_history (
                    history_id SERIAL PRIMARY KEY,
                    operation_type VARCHAR(10) NOT NULL,
                    operation_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                    changed_by VARCHAR(20),
                    
                    -- Mirror all employee table columns
                    id INTEGER,
                    employee_id VARCHAR(20),
                    first_name VARCHAR(50),
                    middle_name VARCHAR(50),
                    last_name VARCHAR(50),
                    date_of_birth DATE,
                    contact_number VARCHAR(15),
                    emergency_contact_number VARCHAR(15),
                    emergency_contact_person VARCHAR(50),
                    emergency_contact_relation VARCHAR(50),
                    email VARCHAR(100),
                    personal_email VARCHAR(100),
                    gender VARCHAR(1),
                    blood_group VARCHAR(10),
                    date_of_joining DATE,
                    ctc NUMERIC(18, 2),
                    team_lead_id VARCHAR(20),
                    highest_qualification VARCHAR(100),
                    employment_status VARCHAR(50),
                    sub_role INTEGER,
                    lob_lead VARCHAR(50),
                    is_lead BOOLEAN,
                    qualification_year_month VARCHAR(10),
                    full_stack_ready BOOLEAN,
                    date_of_resignation DATE,
                    lwd DATE,
                    lwp INTEGER,
                    internship_end_date DATE,
                    probation_end_date DATE,
                    privilege_leaves INTEGER,
                    sick_leaves INTEGER,
                    remaining_leaves INTEGER,
                    profile_image_type VARCHAR(20),
                    
                    created_at TIMESTAMP,
                    updated_at TIMESTAMP
                )
            """)
            
            conn.execute(create_table_sql)
            conn.commit()
            print("âœ“ employee_history table created successfully")
            
    except Exception as e:
        print(f"Error creating employee_history table: {e}")
